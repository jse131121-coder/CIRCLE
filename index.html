<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AOUSE</title>
<style>
*{box-sizing:border-box;font-family:Arial, sans-serif}
body{margin:0;background:#f5f7fb}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:white;border-bottom:1px solid #eee}
.logo{font-weight:800;font-size:22px}
.btn{padding:8px 14px;border-radius:14px;border:none;background:#222;color:white;cursor:pointer}
.container{max-width:900px;margin:20px auto;padding:10px;height:calc(100vh - 90px);overflow-y:auto}
.card{background:white;border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 5px 10px rgba(0,0,0,.05)}
.post-item{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.post-title{font-weight:700;font-size:18px}
.badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;color:white;background:#3b82f6;margin-left:5px}
.pinned{color:#f59e0b;margin-right:6px}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:white;border-radius:20px;padding:20px;width:320px;max-height:85vh;overflow-y:auto}
.modal h2{margin-top:0}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:10px}
.flex{display:flex;gap:8px}
.comment{margin-top:10px;padding-left:10px;border-left:2px solid #eee}
.reply{margin-top:6px;margin-left:20px;padding-left:10px;border-left:2px dashed #ddd;font-size:14px}
.mention{color:#3b82f6;font-weight:bold}
</style>
</head>
<body>

<header>
<div class="logo">RODESTAR</div>
<div>
<button id="writeBtn" class="btn" style="display:none">ê¸€ì“°ê¸°</button>
<button id="loginBtn" class="btn">WAY</button>
</div>
</header>

<div class="container" id="postList"></div>

<!-- LOGIN -->
<div class="modal-bg" id="loginModal">
<div class="modal">
<h2>ARRIVE</h2>
<input class="input" id="loginId" placeholder="ID">
<input class="input" id="loginPw" type="password" placeholder="CODE">
<div class="flex">
<button class="btn" id="loginClose">BACK</button>
<button class="btn" id="loginGo">GO</button>
</div>
</div>
</div>

<!-- WRITE -->
<div class="modal-bg" id="writeModal">
<div class="modal">
<h2>ê¸€ì“°ê¸°</h2>
<input class="input" id="postTitle">
<textarea class="input" id="postContent"></textarea>
<input class="input" type="file" id="postImage" multiple>
<label><input type="checkbox" id="postPinned"> pinned</label>
<div class="flex">
<button class="btn" id="writeCancel">ì·¨ì†Œ</button>
<button class="btn" id="writeSubmit">ë“±ë¡</button>
</div>
</div>
</div>

<!-- VIEW -->
<div class="modal-bg" id="viewModal">
<div class="modal" style="width:90%;max-width:500px">
<div id="viewContent"></div>
<hr>
<input class="input" id="commentInput" placeholder="ëŒ“ê¸€ ì‘ì„±">
<button class="btn" id="commentSubmit">ëŒ“ê¸€ ë“±ë¡</button>
<div id="commentList"></div>
<button class="btn" id="viewClose" style="margin-top:10px">ë‹«ê¸°</button>
</div>
</div>

<script>
let posts = JSON.parse(localStorage.getItem('aouse_posts')) || [];
let user = JSON.parse(localStorage.getItem('aouse_user')) || null;
let currentPost = null;
let editMode = false;

if(posts.length===0){
 posts.push({
  id:Date.now(),
  title:"!!AOUSE ì´ìš© ì•ˆë‚´!!",
  content:"ì•ˆë…•í•˜ì„¸ìš”! AOUSE ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤.",
  images:[],
  pinned:true,
  author:"ARCEN",
  badge:true,
  date:new Date().toLocaleString(),
  time:Date.now(),
  comments:[]
 });
 save();
}

function save(){
 localStorage.setItem('aouse_posts',JSON.stringify(posts));
}

function renderMention(text){
 return text.replace(/@(\w+)/g,'<span class="mention">@$1</span>');
}

function render(){
 const list=document.getElementById('postList');
 list.innerHTML='';

 const sorted=[...posts].sort((a,b)=>{
  if(b.pinned!==a.pinned) return b.pinned-a.pinned;
  return b.time-a.time;
 });

 sorted.forEach(p=>{
  const div=document.createElement('div');
  div.className='card post-item';
  div.innerHTML=`
   <div>
    <span class='pinned'>${p.pinned?'ğŸ“Œ':''}</span>
    <span class='post-title'>${p.title}</span>
   </div>
   <div>${p.author}${p.badge?'<span class="badge">âœ”</span>':''}</div>
  `;
  div.onclick=()=>openPost(p.id);
  list.appendChild(div);
 });
}

function openPost(id){
 currentPost=posts.find(p=>p.id===id);
 viewModal.style.display='flex';

 const controls=(user && user.id===currentPost.author)
 ? `<div style="margin-top:10px">
 <button class="btn" onclick="editPost()">ìˆ˜ì •</button>
 <button class="btn" onclick="deletePost()">ì‚­ì œ</button>
 </div>`:'';

 viewContent.innerHTML=`
 <b>${currentPost.title}</b><br>
 <small>${currentPost.author} Â· ${currentPost.date}</small>
 <p>${renderMention(currentPost.content).replace(/\n/g,'<br>')}</p>
 ${currentPost.images
   ? currentPost.images.map(i=>'<img src="'+i+'" width="100%" style="margin-top:8px">').join('')
   : ''}
 ${controls}
 `;
 renderComments();
}

function renderComments(){
 commentList.innerHTML='';
 currentPost.comments.forEach((c,i)=>{
  const d=document.createElement('div');
  d.className='comment';
  d.innerHTML=`
   <b>${c.author}</b><br>
   ${renderMention(c.text)}
   <input class="input" placeholder="reply..."
    onkeydown="if(event.key=='Enter') addReply(${i},this.value)">
  `;

  c.replies.forEach(r=>{
   const rep=document.createElement('div');
   rep.className='reply';
   rep.innerHTML=`<b>${r.author}</b> ${renderMention(r.text)}`;
   d.appendChild(rep);
  });

  commentList.appendChild(d);
 });
}

function addComment(){
 if(!user){alert('ë¡œê·¸ì¸ í•„ìš”');return}
 const txt=commentInput.value.trim();
 if(!txt) return;

 currentPost.comments.push({
  author:user.id,
  text:txt,
  replies:[]
 });

 save();
 commentInput.value='';
 renderComments();
}

function addReply(idx,text){
 if(!user) return;
 if(!text.trim()) return;

 currentPost.comments[idx].replies.push({
  author:user.id,
  text:text
 });

 save();
 renderComments();
}

function login(){
 const id=loginId.value.trim();
 const pw=loginPw.value.trim();
 if(!id||!pw){alert('ì •ë³´ ì…ë ¥');return}
 user={id};
 localStorage.setItem('aouse_user',JSON.stringify(user));
 loginModal.style.display='none';
 writeBtn.style.display='inline-block';
}

function submitPost(){
 if(!user) return;

 const t=postTitle.value;
 const c=postContent.value;
 const pin=postPinned.checked;
 const files=[...postImage.files];

 let images=[];
 let loaded=0;

 function finish(){

  if(editMode){
   currentPost.title=t;
   currentPost.content=c;
   currentPost.pinned=pin;
   if(images.length>0) currentPost.images=images;
   editMode=false;
  } else {
   posts.push({
    id:Date.now(),
    title:t,
    content:c,
    images:images,
    pinned:pin,
    author:user.id,
    badge:false,
    date:new Date().toLocaleString(),
    time:Date.now(),
    comments:[]
   });
  }

  save();
  closeWrite();
  render();
 }

 if(files.length===0){
  finish();
  return;
 }

 files.forEach(file=>{
  const reader=new FileReader();
  reader.onload=function(){
   images.push(reader.result);
   loaded++;
   if(loaded===files.length) finish();
  };
  reader.readAsDataURL(file);
 });
}

function editPost(){
 editMode=true;
 viewModal.style.display='none';
 writeModal.style.display='flex';
 postTitle.value=currentPost.title;
 postContent.value=currentPost.content;
 postPinned.checked=currentPost.pinned;
}

function deletePost(){
 if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
 posts=posts.filter(p=>p.id!==currentPost.id);
 save();
 viewModal.style.display='none';
 render();
}

function closeWrite(){
 writeModal.style.display='none';
 postTitle.value='';
 postContent.value='';
 postPinned.checked=false;
 editMode=false;
}

loginBtn.onclick=()=>loginModal.style.display='flex';
loginClose.onclick=()=>loginModal.style.display='none';
loginGo.onclick=login;
writeBtn.onclick=()=>writeModal.style.display='flex';
writeCancel.onclick=closeWrite;
writeSubmit.onclick=submitPost;
commentSubmit.onclick=addComment;
viewClose.onclick=()=>viewModal.style.display='none';

if(user) writeBtn.style.display='inline-block';

render();
</script>

</body>
</html>
